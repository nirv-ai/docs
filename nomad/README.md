# NIRVai Nomad docs

documentation for Nomad @ NIRVai

## RACEXP

- [NIRV DOCS project board](https://github.com/orgs/nirv-ai/projects/6/views/1?filterQuery=repo%3A%22nirv-ai%2Fdocs%22)
- [RACEXP docs](https://github.com/noahehall/theBookOfNoah/blob/master/0current/architectural%20thinking/0racexp.md)

## helpful links

- [error about cni plugin](https://discuss.hashicorp.com/t/failed-to-find-plugin-bridge-in-path/3095)
- [enabling bind mounts](https://developer.hashicorp.com/nomad/docs/drivers/docker#enabled-1)
- [vault container requires ipc_lock](https://developer.hashicorp.com/nomad/docs/drivers/docker#allow_caps)

## development validation workflow

### REQUIREMENTS

- [you have nirvai/scripts in your path](../scripts/README.md)
- [you have nomad development configs](../configs/README.md)
  - copypasta the configs: `core/apps/nomad app/dev/configs-go-here`
- you have a [local docker registry setup](../docker/README.md)
- you've setup [TLS with cloudflare cfssl](./tls.md)

- your directory structure should look like this before continuing

```sh
./you-are-here
├── configs # source of development.*.nomad configs
├── core # your monorepo
    ├── apps
        ├── nirvai-web-nomad # nomad application
            ├── dev # nomad development directory
                ├── tls # where we will store keys generated by cfssl
                    └── server.pem
                    ├── cfssl.json
                    ├── cli-key.pem
                    ├── cli.csr
                    ├── cli.pem
                    ├── client-key.pem
                    ├── client.csr
                    ├── client.pem
                    ├── nomad-ca-key.pem
                    ├── nomad-ca.csr
                    ├── nomad-ca.pem
                    ├── server-key.pem
                    ├── server.csr
                ├── development.client.nomad # nomad client agent config
                ├── development.server.nomad # nomad server agent config
                ├── development.dev_core.nomad # nomad jobspec

```

### setup env for development validation in Nomad

- transitioning from: active development in docker compose
  - e.g. where apps are developed and tests are executed
- transitioning to: development validation in nomad
  - e.g. when e2e tests are executed and _validated_ and PRs are ready for review

```sh
# in all examples: `$CORE` is the root of your monorepo

########### cd $CORE
# start a docker registry
script.registry.sh run


# skip this step if:
## ^ your local images are up to date
## ^ you havent made any changes to development environment variables

## recreate .env.development.compose.{json,yaml} and force it to nomad/dev
script.refresh.compose.sh
cp -f ./.env.development.compose.* ./apps/nirvai-web-nomad/dev/


# skip this step if:
## ^ your local registry has the latest images

## tag-and-push all images backing running containers to the registry
## if your containers arent running use `tag IMAGE_NAME`
script.registry.sh tag_running

## stop all development containers (nomad uses the images in the registry)
docker compose down

```

### INTERFACE

```sh
########### cd apps/nirvai-web-nomad/dev

NOMAD_ADDR_SUBD=dev
NOMAD_ADDR_HOST=nirv.ai
NOMAD_SERVER_PORT=4646
NOMAD_ADDR=https://$NOMAD_ADDR_SUBD.$NOMAD_ADDR_HOST:$NOMAD_SERVER_PORT
NOMAD_CACERT=./tls/nomad-ca.pem
NOMAD_CLIENT_CERT=./tls/cli.pem
NOMAD_CLIENT_KEY=./tls/cli-key.pem

```

### start nomad server and client agents

```sh
########### cd apps/nirvai-web-nomad/dev
# start server agent in bg
script.nmd.sh start s -config=development.server.nomad

# start client agent in bg
script.nmd.sh start c -config=development.client.nomad

# check the server status
script.nmd.sh get status servers

# check the client status
script.nmd.sh get status clients
# open the Nomad UI: https://mad.nirv.ai:4646
```

### deploy nomad jobspec

```sh
# if ./development.dev_core.nomad doesnt exist create it
script.nmd.sh create job dev_core

# get a fresh job plan and retrieve the index number from stdout
## we validate every config and jobspec, deal with the errors
script.nmd.sh get plan dev_core

# deploy job dev_core
script.nmd.sh run dev_core indexNumber

# review logs of containers initialized by nomad
script.nmd.sh dockerlogs

# on error run
script.nmd.sh get status job jobName # includes all allocationIds
script.nmd.sh get status loc allocationId # in event of deployment failure
script.nmd.sh get status clients # see client nodes and there ids
script.nmd.sh dockerlogs # following docker logs of all running containers
nomad alloc exec -i -t -task sidekiq fa2b2ed6 /bin/bash # todo,
nomad alloc exec -i -t -task puma fa2b2ed6 /bin/bash -c "bundle exec rails c" #todo
nomad job history -p job_name # todo

# cleanup
# rm the job
script.nmd.sh rm dev_core

# kill the team @see https://github.com/noahehall/theBookOfNoah/blob/master/linux/bash_cli_fns/000util.sh
kill_service_by_name nomad

# reset nomad to a green state if you dont plan on using it later
script.nmd.sh gc
```

## next steps

- Congrats!
- checkout usage [script.nmd.sh usage docs](./usage.md)
